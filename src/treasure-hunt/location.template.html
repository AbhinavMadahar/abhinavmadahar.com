<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="$lang$" xml:lang="$lang$"$if(dir)$ dir="$dir$"$endif$>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title class="title">$if(title-prefix)$$title-prefix$ – $endif$$pagetitle$</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
$if(quotes)$
      q { quotes: "“" "”" "‘" "’"; }
$endif$
  </style>
$if(highlighting-css)$
  <style type="text/css">
$highlighting-css$
  </style>
$endif$
$for(css)$
  <link rel="stylesheet" href="$css$" />
$endfor$
$if(math)$
  $math$
$endif$
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="/treasure-hunt/treasure-hunt.css" />
$for(header-includes)$
  $header-includes$
$endfor$
</head>
<body>
$for(include-before)$
$include-before$
$endfor$
$if(title)$
<header id="title-block-header">
<br />
<div class="container">
<h1 class="title">$title$</h1>
$if(subtitle)$
<p class="subtitle">$subtitle$</p>
$endif$
$if(date)$
<h2 class="date">$date$</h2>
</div>
$endif$
</header>
$endif$
$if(toc)$
<nav id="$idprefix$TOC">
$table-of-contents$
</nav>
$endif$
<hr />
$body$
$for(include-after)$
$include-after$
$endfor$
$if(next)$
<p><button id="check">Check to see if you're at the next location.</button></p>
$endif$
<br />

$if(status)$
<hr />
<h2>Status</h2>
<p>HP: <span id="hp"></span></p>
<p>Items in inventory:</p>
<ul id="items">
</ul>
<script>
	document.getElementById('hp').innerHTML = localStorage.hp;

	if (localStorage.sword === 'true') {
		document.getElementById('items').innerHTML += '<li>Sword</li>';
	}
</script>
<hr />
$endif$

$if(region)$
<p>The next clue is in the shaded region.</p>
<img src="/treasure-hunt/regions/$region$.png" class="region">
$endif$

$if(next)$
<script>
	const goal_latitude = Number("$goal$".split(', ')[0]);
	const goal_longitude = Number("$goal$".split(', ')[1]);

	const radian = (degrees) => degrees * (Math.PI / 180);

	document.getElementById("check").addEventListener('click', () => {
		navigator.geolocation.getCurrentPosition(position => {
			const player_latitude = position.coords.latitude;
			const player_longitude = position.coords.longitude;
			const player_accuracy = position.coords.accuracy;

			// now, we can approximate the World as being flat for such a small distance.
			// that way, we can find the distance using a simple Euclidean calculation

			const radius = 6371000;  // radius of the World in metres because the navigator API uses metres
			const distance = 2 * radius * Math.asin(Math.sqrt(Math.pow(Math.sin(radian(player_latitude - goal_latitude) / 2), 2) + Math.cos(player_latitude) * Math.cos(goal_latitude) * Math.pow(Math.sin(radian(player_longitude - goal_longitude) / 2), 2)));
			$if(radius)$
			const acceptable_distance = $radius$ + player_accuracy;  // we let them be farther than 50m if they have a poor GPS connexion
			$else$
			const acceptable_distance = 25 + player_accuracy;  // we let them be farther than 50m if they have a poor GPS connexion
			$endif$

			if (distance < acceptable_distance) {
				alert('You found the clue! Click OK to continue to the next clue.');
				window.location = "/treasure-hunt/locations/$next$.html";
			} else {
				$if(radius)$
				alert("No, you're not there yet. Remember that you have to be within $radius$ metres of the target.");
				$else$
				alert("No, you're not there yet. Remember that you have to be within 25 metres of the target.");
				$endif$
			}

		}, () => undefined, { enableHighAccuracy: true });
	});
</script>
$endif$

</body>
</html>
